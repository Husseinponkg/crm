<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Trends</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/main.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            padding: 2rem;
        }
        
        .dashboard {
            flex: 1;
        }
        
        .chart-container {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--light);
        }
        
        canvas {
            max-height: 500px;
        }
        
        .loading-message {
            text-align: center;
            color: var(--gray);
            font-style: italic;
            padding: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        .refresh-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 2rem;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .refresh-btn:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon"><i class="fas fa-chart-line"></i></div>
                    <div class="logo-text">Fortishield CRM</div>
                </div>
                
                <nav class="nav">
                    <a href="customers_view.html"><i class="fas fa-users"></i> Customers</a>
                    <a href="trends.html" class="active"><i class="fas fa-chart-line"></i> Analytics</a>
                    <a href="communications.html"><i class="fas fa-comments"></i> Communications</a>
                </nav>
                
                <div class="user-actions">
                    <button class="notification-btn">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">3</span>
                    </button>
                    
                    <div class="user-profile">
                        <div class="avatar">JD</div>
                        <span>John Doe</span>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="main-content">
            <main class="dashboard">
                <div class="welcome-banner">
                    <h1>Customer Trends Dashboard</h1>
                    <p>Analyze customer data and identify patterns to improve business decisions.</p>
                </div>
                
                <button id="refreshBtn" class="refresh-btn"><i class="fas fa-sync-alt"></i> Refresh Data</button>
                
                <!-- Service Distribution Chart -->
                <div class="chart-container">
                    <div class="chart-title">Service Distribution</div>
                    <canvas id="serviceChart"></canvas>
                    <div id="serviceChartMessage" class="loading-message">Loading data...</div>
                </div>
                
                <!-- Customer Growth Over Time Chart -->
                <div class="chart-container">
                    <div class="chart-title">Customer Growth Over Time</div>
                    <canvas id="growthChart"></canvas>
                    <div id="growthChartMessage" class="loading-message">Loading data...</div>
                </div>
                
                <!-- Top Services Chart -->
                <div class="chart-container">
                    <div class="chart-title">Top Services</div>
                    <canvas id="topServicesChart"></canvas>
                    <div id="topServicesChartMessage" class="loading-message">Loading data...</div>
                </div>
            </main>
        </div>
        
        <footer>
            <div class="footer-content">
                <div class="copyright">Â© 2023 Fortishield Matrix CRM. All rights reserved.</div>
                <div class="footer-links">
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                    <a href="#">Contact Us</a>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Initialize charts
        let serviceChart, growthChart, topServicesChart;
        
        // Fetch service statistics from API
        async function fetchServiceStatistics() {
            try {
                console.log('Fetching service statistics...');
                // Try to fetch from the database-based endpoint first
                let response = await fetch('/api/trends');
                console.log('Database-based endpoint response status:', response.status);
                if (!response.ok) {
                    // Fallback to file-based endpoint
                    console.log('Falling back to file-based endpoint');
                    response = await fetch('/api/trends/file');
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Received data:', data);
                
                // Update charts with real data
                updateCharts(data);
            } catch (error) {
                console.error('Error fetching service statistics:', error);
                // Show error message on charts
                showMessage('serviceChartMessage', 'Error loading data');
                showMessage('topServicesChartMessage', 'Error loading data');
                showMessage('growthChartMessage', 'Error loading data');
            }
        }
        
        // Show message on a chart
        function showMessage(elementId, message) {
            const element = document.getElementById(elementId);
            const canvasId = elementId.replace('Message', '');
            const canvas = document.getElementById(canvasId);
            
            // Hide canvas and show message
            canvas.classList.add('hidden');
            element.classList.remove('hidden');
            element.textContent = message;
        }
        
        // Show chart
        function showChart(canvasId) {
            const canvas = document.getElementById(canvasId);
            const messageElement = document.getElementById(canvasId + 'Message');
            
            // Show canvas and hide message
            canvas.classList.remove('hidden');
            messageElement.classList.add('hidden');
        }
        
        // Update charts with fetched data
        function updateCharts(data) {
            try {
                console.log('Updating charts with data:', data);
                
                // Service Distribution Chart
                if (data.serviceDistribution && data.serviceDistribution.length > 0) {
                    const serviceCtx = document.getElementById('serviceChart').getContext('2d');
                    if (serviceChart) serviceChart.destroy();
                    
                    showChart('serviceChart');
                    
                    const serviceData = data.serviceDistribution;
                    serviceChart = new Chart(serviceCtx, {
                        type: 'pie',
                        data: {
                            labels: serviceData.map(item => item.service),
                            datasets: [{
                                data: serviceData.map(item => item.count),
                                backgroundColor: [
                                    '#FF6384',
                                    '#36A2EB',
                                    '#FFCE56',
                                    '#4BC0C0',
                                    '#9966FF',
                                    '#FF9F40'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: 'Distribution of Services'
                                }
                            }
                        }
                    });
                } else {
                    // Clear the chart completely when there's no data
                    showChart('serviceChart');
                    if (serviceChart) serviceChart.destroy();
                    const serviceCtx = document.getElementById('serviceChart').getContext('2d');
                    serviceChart = new Chart(serviceCtx, {
                        type: 'pie',
                        data: {
                            labels: [],
                            datasets: [{
                                data: [],
                                backgroundColor: []
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: 'Distribution of Services'
                                }
                            }
                        }
                    });
                }
                
                // Customer Growth Over Time Chart
                if (data.customerGrowth && data.customerGrowth.length > 0) {
                    const growthCtx = document.getElementById('growthChart').getContext('2d');
                    if (growthChart) growthChart.destroy();
                    
                    showChart('growthChart');
                    
                    const growthData = data.customerGrowth;
                    
                    // Prepare datasets for the chart
                    const datasets = [
                        {
                            label: 'New Customers',
                            data: growthData.map(item => item.count),
                            borderColor: '#36A2EB',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            fill: false,
                            tension: 0 // Remove smoothing for zigzag appearance
                        },
                        {
                            label: 'Cumulative Customers',
                            data: growthData.map(item => item.cumulative_count),
                            borderColor: '#FF6384',
                            backgroundColor: 'rgba(255, 9, 132, 0.2)',
                            fill: false,
                            tension: 0 // Remove smoothing for zigzag appearance
                        }
                    ];
                    
                    // If we have service growth data, add it to the chart
                    if (data.serviceGrowth && data.serviceGrowth.length > 0) {
                        try {
                            // Group service growth data by service
                            const serviceGrowthByService = {};
                            data.serviceGrowth.forEach(item => {
                                if (!serviceGrowthByService[item.service]) {
                                    serviceGrowthByService[item.service] = [];
                                }
                                serviceGrowthByService[item.service].push(item);
                            });
                            
                            // Create a color palette for services
                            const serviceColors = [
                                '#4BC0C0', '#9966FF', '#FF9F40', '#FFCD56',
                                '#C9CBCF', '#4D5360', '#F7464A', '#E2EAE9'
                            ];
                            
                            // Add each service as a separate dataset
                            let colorIndex = 0;
                            Object.keys(serviceGrowthByService).forEach(service => {
                                const serviceData = serviceGrowthByService[service];
                                // Create a complete timeline with zero values for missing dates
                                const completeTimeline = growthData.map(growthItem => {
                                    const serviceItem = serviceData.find(item => item.date === growthItem.date);
                                    return serviceItem ? serviceItem.count : 0;
                                });
                                
                                datasets.push({
                                    label: service,
                                    data: completeTimeline,
                                    borderColor: serviceColors[colorIndex % serviceColors.length],
                                    backgroundColor: serviceColors[colorIndex % serviceColors.length] + '20',
                                    fill: false,
                                    tension: 0, // Remove smoothing for zigzag appearance
                                    hidden: true // Initially hidden to avoid clutter
                                });
                                colorIndex++;
                            });
                        } catch (error) {
                            console.error('Error processing service growth data:', error);
                        }
                    }
                    
                    growthChart = new Chart(growthCtx, {
                        type: 'line',
                        data: {
                            labels: growthData.map(item => item.date),
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Customer Growth Over Time'
                                },
                                legend: {
                                    display: true,
                                    position: 'top'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            },
                            interaction: {
                                mode: 'index',
                                intersect: false
                            }
                        }
                    });
                } else {
                    showMessage('growthChartMessage', 'No data available');
                    // Clear the chart completely when there's no data
                    showChart('growthChart');
                    if (growthChart) growthChart.destroy();
                    const growthCtx = document.getElementById('growthChart').getContext('2d');
                    growthChart = new Chart(growthCtx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [
                                {
                                    label: 'New Customers',
                                    data: [],
                                    borderColor: '#36A2EB',
                                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                    fill: false
                                },
                                {
                                    label: 'Cumulative Customers',
                                    data: [],
                                    borderColor: '#FF6384',
                                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                    fill: false
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Customer Growth Over Time'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
                
                // Top Services Chart
                if (data.topServices && data.topServices.length > 0) {
                    const topServicesCtx = document.getElementById('topServicesChart').getContext('2d');
                    if (topServicesChart) topServicesChart.destroy();
                    
                    showChart('topServicesChart');
                    
                    const topServicesData = data.topServices;
                    topServicesChart = new Chart(topServicesCtx, {
                        type: 'bar',
                        data: {
                            labels: topServicesData.map(item => item.service),
                            datasets: [{
                                label: 'Number of Customers',
                                data: topServicesData.map(item => item.count),
                                backgroundColor: '#4BC0C0'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Top Services'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                } else {
                    showMessage('topServicesChartMessage', 'No data available');
                    // Clear the chart completely when there's no data
                    showChart('topServicesChart');
                    if (topServicesChart) topServicesChart.destroy();
                    const topServicesCtx = document.getElementById('topServicesChart').getContext('2d');
                    topServicesChart = new Chart(topServicesCtx, {
                        type: 'bar',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Number of Customers',
                                data: [],
                                backgroundColor: '#4BC0C0'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Top Services'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                }
                
                console.log('Charts updated successfully');
            } catch (error) {
        // Function to refresh charts when a customer is added
        window.onCustomerAdded = function() {
            console.log('Customer added, refreshing charts...');
            fetchServiceStatistics();
        };
                console.error('Error updating charts:', error);
                // Show error message on charts
                showMessage('serviceChartMessage', 'Error loading data');
                showMessage('growthChartMessage', 'Error loading data');
                showMessage('topServicesChartMessage', 'Error loading data');
            }
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, fetching data...');
            
            // Initially show loading messages
            showMessage('serviceChartMessage', 'Loading data...');
            showMessage('growthChartMessage', 'Loading data...');
            showMessage('topServicesChartMessage', 'Loading data...');
            
            // Then try to fetch real data
            fetchServiceStatistics();
            
            // Set up refresh button
            document.getElementById('refreshBtn').addEventListener('click', fetchServiceStatistics);
            
            // Refresh data every 30 seconds
            setInterval(fetchServiceStatistics, 30000);
        });
        
        // Function to refresh charts when a customer is deleted
        window.onCustomerDeleted = function() {
            console.log('Customer deleted, refreshing charts...');
            fetchServiceStatistics();
        };
    </script>
</body>
</html>